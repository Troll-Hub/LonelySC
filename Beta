 do
		if btn and btn:IsA("TextButton") then
			TweenService:Create(btn, TweenInfo.new(0.12, Enum.EasingStyle.Quad), {BackgroundColor3 = Color3.fromRGB(30,30,30)}):Play()
			btn.TextColor3 = Color3.fromRGB(255,255,255)
		end
	end
	selectedIndex = idx
	local btn = suggestionButtons[selectedIndex]
	if btn and btn:IsA("TextButton") then
		TweenService:Create(btn, TweenInfo.new(0.12, Enum.EasingStyle.Quad), {BackgroundColor3 = Color3.fromRGB(80,80,80)}):Play()
		btn.TextColor3 = Color3.fromRGB(0,255,0)
		pcall(function() SuggestionsList.CanvasPosition = Vector2.new(0, math.max(0, (selectedIndex-1) * (btn.AbsoluteSize.Y + 6) - 22)) end)
	end
end

local function addSuggestionText(text)
	local btn = Instance.new("TextButton")
	btn.Size = UDim2.new(1, 0, 0, 28)
	btn.BackgroundTransparency = 1
	btn.BackgroundColor3 = Color3.fromRGB(30,30,30)
	btn.TextColor3 = Color3.fromRGB(255,255,255)
	btn.TextScaled = false
	btn.Font = Enum.Font.Gotham
	btn.Text = text
	btn.AutoButtonColor = false
	btn.Parent = SuggestionsList
	btn.ClipsDescendants = true

	local corner = Instance.new("UICorner", btn); corner.CornerRadius = UDim.new(0,10)
	local stroke = Instance.new("UIStroke", btn); stroke.Thickness = 1; stroke.Color = Color3.fromRGB(45,45,45); stroke.Transparency = 0.45

	btn.BackgroundTransparency = 1
	btn.TextTransparency = 1
	task.delay(0.01, function()
		pcall(function()
			TweenService:Create(btn, TweenInfo.new(0.14, Enum.EasingStyle.Quad), {BackgroundTransparency = 0, TextTransparency = 0}):Play()
		end)
	end)

	local originalSize = btn.Size
	local hoverSize = UDim2.new(1, 6, 0, 32)
	btn.MouseEnter:Connect(function()
		pcall(function()
			TweenService:Create(btn, TweenInfo.new(0.12, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Size = hoverSize}):Play()
			TweenService:Create(btn, TweenInfo.new(0.12), {BackgroundColor3 = Color3.fromRGB(70,70,70)}):Play()
		end)
	end)
	btn.MouseLeave:Connect(function()
		pcall(function()
			TweenService:Create(btn, TweenInfo.new(0.12, Enum.EasingStyle.Quad), {Size = originalSize}):Play()
			TweenService:Create(btn, TweenInfo.new(0.12), {BackgroundColor3 = Color3.fromRGB(30,30,30)}):Play()
		end)
	end)

	btn.MouseButton1Click:Connect(function()
		InputBox.Text = text
		SuggestionsFrame.Visible = false
		clearSuggestions()
	end)

	table.insert(suggestionButtons, btn)
end

local function collectAutocompleteItems()
	local items = {}
	table.insert(items, "all") table.insert(items, "others") table.insert(items, "me")
	table.insert(items, "npcs") table.insert(items, "allnpcs")
	for _, p in ipairs(Players:GetPlayers()) do
		table.insert(items, p.Name or "")
		table.insert(items, p.DisplayName or "")
	end
	for _, npc in ipairs(getAllNPCs()) do
		table.insert(items, npc.Name or "")
	end
	return items
end

local function updateSuggestionsImmediate(text)
	clearSuggestions()
	if not text or text == "" then SuggestionsFrame.Visible = false return end
	local lower = string.lower(text)
	local added = 0
	local items = collectAutocompleteItems()
	for _, item in ipairs(items) do
		if type(item) == "string" and string.lower(item):find(lower) then
			addSuggestionText(item)
			added = added + 1
			if added >= 10 then break end
		end
	end
	if added > 0 then
		SuggestionsFrame.Visible = true
		local totalHeight = (#suggestionButtons) * 34
		SuggestionsList.CanvasSize = UDim2.new(0, 0, 0, totalHeight)
		setSelectedIndex(1)
	else
		SuggestionsFrame.Visible = false
	end
end

function scheduleSuggestionsUpdate()
	if suggestionDebounced then
		lastPendingText = InputBox.Text or ""
		return
	end
	suggestionDebounced = true
	lastPendingText = InputBox.Text or ""
	task.delay(0.08, function()
		updateSuggestionsImmediate(lastPendingText)
		suggestionDebounced = false
	end)
end

InputBox:GetPropertyChangedSignal("Text"):Connect(function()
	lastPendingText = InputBox.Text or ""
	if not suggestionDebounced then scheduleSuggestionsUpdate() end
end)
Players.PlayerAdded:Connect(function() scheduleSuggestionsUpdate() end)
Players.PlayerRemoving:Connect(function() scheduleSuggestionsUpdate() end)

-- Click fuera: cerrar sugerencias si visible (simple)
UserInputService.InputBegan:Connect(function(input, processed)
	if processed then return end
	if input.UserInputType == Enum.UserInputType.MouseButton1 and SuggestionsFrame.Visible then
		task.delay(0.05, function()
			if SuggestionsFrame.Visible then
				SuggestionsFrame.Visible = false
				clearSuggestions()
			end
		end)
	end
end)

-------------------------------------------------------------------
-- Particle effect
-------------------------------------------------------------------
local function spawnParticleEffect(button)
	for i = 1, 4 do
		local particle = Instance.new("ImageLabel")
		particle.Size = UDim2.new(0,6,0,6)
		particle.Position = UDim2.new(0.5,0,0.5,0)
		particle.AnchorPoint = Vector2.new(0.5,0.5)
		particle.BackgroundTransparency = 1
		particle.Image = "rbxassetid://2795790"
		particle.ImageColor3 = Color3.new(math.random(), math.random(), math.random())
		particle.Parent = button
		local randomOffset = UDim2.new(0, math.random(-18,18), 0, math.random(-18,18))
		local tweenInfo = TweenInfo.new(0.45, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
		local tween = TweenService:Create(particle, tweenInfo, { Position = randomOffset, ImageTransparency = 0 })
		tween:Play()
		tween.Completed:Connect(function() particle:Destroy() end)
	end
end

-------------------------------------------------------------------
-- Targets resolution (players + NPCs)
-------------------------------------------------------------------
local function getTargets(targetText)
	local lowerTarget = string.lower(targetText or "")
	local results = {}
	if lowerTarget == "all" then
		for _, p in ipairs(Players:GetPlayers()) do table.insert(results, p) end
		for _, npc in ipairs(getAllNPCs()) do table.insert(results, npc) end
		return results
	elseif lowerTarget == "allnpcs" or lowerTarget == "npcs" then
		for _, npc in ipairs(getAllNPCs()) do table.insert(results, npc) end
		return results
	elseif lowerTarget == "others" then
		for _, p in ipairs(Players:GetPlayers()) do if p ~= LocalPlayer then table.insert(results, p) end end
		return results
	elseif lowerTarget == "me" then
		return { LocalPlayer }
	end

	for _, player in ipairs(Players:GetPlayers()) do
		local nameLower = string.lower(player.Name or "")
		local displayLower = string.lower(player.DisplayName or "")
		if nameLower == lowerTarget or displayLower == lowerTarget or nameLower:find(lowerTarget) or displayLower:find(lowerTarget) then
			table.insert(results, player)
		end
	end
	for _, npc in ipairs(getAllNPCs()) do
		local nm = string.lower(npc.Name or "")
		if nm == lowerTarget or nm:find(lowerTarget) then table.insert(results, npc) end
	end
	return results
end

-------------------------------------------------------------------
-- Ejecutar comandos (incluye T objetive arreglado)
-------------------------------------------------------------------
local function executeCommand(command)
	local targetText = InputBox.Text
	local targets = getTargets(targetText)
	if #targets == 0 then
		StarterGui:SetCore("SendNotification", { Title = "Admin", Text = "Objetivo no encontrado.", Duration = 1 })
		return
	end

	for _, t in ipairs(targets) do
		local char = nil
		local isPlayer = false
		local userId = nil

		if typeof(t) == "Instance" then
			if t:IsA("Player") then
				isPlayer = true
				userId = t.UserId
				char = t.Character
			elseif t:IsA("Model") then
				char = t
			end
		else
			if t.Character then char = t.Character end
		end

		local hasHumanoid = char and (char:FindFirstChildOfClass("Humanoid") or char:FindFirstChild("Humanoid"))
		local primary = char and (char:FindFirstChild("PrimaryPart") or char:FindFirstChild("HumanoidRootPart"))

		-- comandos
		if command == "bring" then
			if char and primary and LocalPlayer.Character and LocalPlayer.Character.PrimaryPart then
				local ok, moves = pcall(function() return ReplicatedStorage:FindFirstChild("_BindableEvents") and ReplicatedStorage._BindableEvents:FindFirstChild("Moves") and ReplicatedStorage._BindableEvents.Moves end)
				if ok and moves and moves:FindFirstChild("StopEnemy") then
					pcall(function()
						ReplicatedStorage._BindableEvents.Moves.StopEnemy:FireServer(true, char, LocalPlayer.Character.PrimaryPart.CFrame)
						ReplicatedStorage._BindableEvents.Moves.StopEnemy:FireServer(false, char)
					end)
				end
			end

		elseif command == "kill" then
			if hasHumanoid then
				local humanoid = char:FindFirstChildOfClass("Humanoid") or char:FindFirstChild("Humanoid")
				if humanoid then
					pcall(function()
						if ReplicatedStorage._BindableEvents and ReplicatedStorage._BindableEvents.Moves and ReplicatedStorage._BindableEvents.Moves.TakeDamage then
							ReplicatedStorage._BindableEvents.Moves.TakeDamage:FireServer(humanoid, 1e111, LocalPlayer)
						end
					end)
				end
			end

		elseif command == "heal" then
			if hasHumanoid then
				local humanoid = char:FindFirstChildOfClass("Humanoid") or char:FindFirstChild("Humanoid")
				if humanoid then
					pcall(function()
						if ReplicatedStorage._BindableEvents and ReplicatedStorage._BindableEvents.Moves and ReplicatedStorage._BindableEvents.Moves.TakeDamage then
							ReplicatedStorage._BindableEvents.Moves.TakeDamage:FireServer(humanoid, -1e9, LocalPlayer)
						end
					end)
				end
			end

		elseif command == "punish" then
			if isPlayer and userId and char then
				if not punishBlacklist[userId] then
					punishBlacklist[userId] = true
					spawn(function()
						while punishBlacklist[userId] and char.Parent do
							pcall(function()
								if ReplicatedStorage._BindableEvents and ReplicatedStorage._BindableEvents.Moves and ReplicatedStorage._BindableEvents.Moves.StopEnemy then
									ReplicatedStorage._BindableEvents.Moves.StopEnemy:FireServer(true, char, CFrame.new(math.huge, math.huge, math.huge))
								end
							end)
							wait(0.12)
						end
					end)
				end
			else
				StarterGui:SetCore("SendNotification", { Title="Admin", Text="punish solo v치lido para jugadores.", Duration=1 })
			end

		elseif command == "unpunish" then
			if isPlayer and userId and punishBlacklist[userId] then
				punishBlacklist[userId] = nil
				if char and LocalPlayer.Character and LocalPlayer.Character.PrimaryPart then
					pcall(function()
						if ReplicatedStorage._BindableEvents and ReplicatedStorage._BindableEvents.Moves and ReplicatedStorage._BindableEvents.Moves.StopEnemy then
							ReplicatedStorage._BindableEvents.Moves.StopEnemy:FireServer(true, char, LocalPlayer.Character.PrimaryPart.CFrame)
							ReplicatedStorage._BindableEvents.Moves.StopEnemy:FireServer(false, char)
						end
					end)
				end
			end

		elseif command == "freeze" then
			if char and primary then
				pcall(function()
					if ReplicatedStorage._BindableEvents and ReplicatedStorage._BindableEvents.Moves and ReplicatedStorage._BindableEvents.Moves.StopEnemy then
						ReplicatedStorage._BindableEvents.Moves.StopEnemy:FireServer(true, char, primary.CFrame)
					end
				end)
			end

		elseif command == "unfreeze" then
			if char then
				pcall(function()
					if ReplicatedStorage._BindableEvents and ReplicatedStorage._BindableEvents.Moves and ReplicatedStorage._BindableEvents.Moves.StopEnemy then
						ReplicatedStorage._BindableEvents.Moves.StopEnemy:FireServer(false, char)
					end
				end)
			end

		elseif command == "to" then
			if primary and LocalPlayer.Character and LocalPlayer.Character.PrimaryPart then
				pcall(function() LocalPlayer.Character:SetPrimaryPartCFrame(primary.CFrame) end)
			end

		elseif command == "b1" then
			pcall(function()
				local object = Workspace:FindFirstChild("Map") and Workspace.Map.DBS.DB:FindFirstChild("DB1")
				if object and char and ReplicatedStorage._BindableEvents and ReplicatedStorage._BindableEvents.Moves and ReplicatedStorage._BindableEvents.Moves.StopEnemy then
					ReplicatedStorage._BindableEvents.Moves.StopEnemy:FireServer(true, char, object.CFrame)
					ReplicatedStorage._BindableEvents.Moves.StopEnemy:FireServer(false, char)
				end
			end)

		elseif command == "hk" then
			pcall(function()
				local hakaiItem = game:GetService("TestService"):FindFirstChild("Hakai")
				if hakaiItem then
					local hakaiClone = hakaiItem:Clone()
					hakaiClone.Parent = LocalPlayer.Backpack
				end
			end)

		elseif command == "unlock" then
			pcall(function() loadstring(game:HttpGet("https://raw.githubusercontent.com/Troll-Hub/LonelySC/refs/heads/main/Unlocker%202.5"))() end)

		elseif command == "Force Lag" then
			if char and primary then
				pcall(function()
					if ReplicatedStorage._BindableEvents and ReplicatedStorage._BindableEvents.Moves and ReplicatedStorage._BindableEvents.Moves.BreakStorm then
						ReplicatedStorage._BindableEvents.Moves.BreakStorm:FireServer(true, LocalPlayer.Character, primary.Position, char)
					end
				end)
			else
				StarterGui:SetCore("SendNotification", { Title = "Admin", Text = "El objetivo no tiene personaje v치lido.", Duration = 1 })
			end

		elseif command == "permGod" then
			if hasHumanoid then
				local humanoid = char:FindFirstChildOfClass("Humanoid") or char:FindFirstChild("Humanoid")
				if humanoid then
					pcall(function()
						if ReplicatedStorage._BindableEvents and ReplicatedStorage._BindableEvents.Moves and ReplicatedStorage._BindableEvents.Moves.TakeDamage then
							ReplicatedStorage._BindableEvents.Moves.TakeDamage:FireServer(humanoid, -1e111, LocalPlayer)
							ReplicatedStorage._BindableEvents.Moves.TakeDamage:FireServer(humanoid, 1e111, LocalPlayer)
						end
					end)
				end
			end

		elseif command == "Killer" then
			if char then
				if isPlayer and userId then punishBlacklist[userId] = true end
				pcall(function()
					if ReplicatedStorage._BindableEvents and ReplicatedStorage._BindableEvents.Moves and ReplicatedStorage._BindableEvents.Moves.StopEnemy then
						ReplicatedStorage._BindableEvents.Moves.StopEnemy:FireServer(true, char, CFrame.new(math.huge, math.huge, math.huge))
						ReplicatedStorage._BindableEvents.Moves.StopEnemy:FireServer(false, char)
					end
				end)
			end

		elseif command == "noclans" then
			pcall(function()
				local playerLocal = LocalPlayer
				local Remote = ReplicatedStorage:WaitForChild("SS_Comunication"):WaitForChild("RemoveMember")
				local fixedString = "5yv260y391"
				local hereFolder = playerLocal.PlayerGui:WaitForChild("PlayerInterface")
					:WaitForChild("Menu")
					:WaitForChild("Clans")
					:WaitForChild("Info")
					:WaitForChild("Clan")
					:WaitForChild("Players")
					:WaitForChild("Here")
				for _, child in pairs(hereFolder:GetChildren()) do
					local idValue = child.Name
					local args = {[1] = fixedString, [2] = idValue}
					Remote:FireServer(unpack(args))
					task.wait(0.05)
				end
			end)

		elseif command == "T objetive" then
			-- Arreglado: aplica a players y NPCs por igual (usa 'targets' calculado antes)
			local alreadyExecuted = {}
			local function runForTarget(p)
				if alreadyExecuted[p] then return end
				alreadyExecuted[p] = true

				local function getTargetCharacter(p)
    if p:IsA("Player") then
        local char = p.Character
        if char and char:FindFirstChild("Humanoid") then
            return char
        end
    elseif p:IsA("Model") then
        local humanoid = p:FindFirstChildOfClass("Humanoid")
        if humanoid then
            return p
        end
    end
    return nil
end

				if targetChar and targetChar:FindFirstChildOfClass("Humanoid") then
					local humanoid = targetChar:FindFirstChildOfClass("Humanoid") or targetChar:FindFirstChild("Humanoid")
					local args = {
						[1] = {
							["Humanoid"] = humanoid,
							["Head"] = targetChar:FindFirstChild("Head"),
							["UpperTorso"] = targetChar:FindFirstChild("UpperTorso") or targetChar:FindFirstChild("Torso"),
							["HumanoidRootPart"] = targetChar:FindFirstChild("HumanoidRootPart"),
							["Character"] = targetChar
						},
						[2] = (LocalPlayer.Status and LocalPlayer.Status.Mode) or nil,
						[3] = (targetChar.Status and targetChar.Status.ModeActive) or nil,
						[4] = targetChar.Status,
						[5] = false
					}
					pcall(function()
						if ReplicatedStorage._BindableEvents and ReplicatedStorage._BindableEvents.Transform then
							ReplicatedStorage._BindableEvents.Transform:InvokeServer(unpack(args))
						end
					end)
				end
			end

			-- ejecuta para cada objetivo resuelto
			for _, p in ipairs(targets) do runForTarget(p) end
		end
	end

	StarterGui:SetCore("SendNotification", { Title="游낼Custom", Text="Comando ejecutado: "..string.upper(command), Duration=0.6 })
end

-------------------------------------------------------------------
-- Reaplicar punish a jugadores en blacklist al unirse
-------------------------------------------------------------------
Players.PlayerAdded:Connect(function(player)
	if punishBlacklist[player.UserId] then
		player.CharacterAdded:Connect(function(character)
			spawn(function()
				while player.Parent and punishBlacklist[player.UserId] do
					pcall(function()
						if ReplicatedStorage._BindableEvents and ReplicatedStorage._BindableEvents.Moves and ReplicatedStorage._BindableEvents.Moves.StopEnemy then
							ReplicatedStorage._BindableEvents.Moves.StopEnemy:FireServer(true, character, CFrame.new(math.huge, math.huge, math.huge))
						end
					end)
					wait(0.12)
				end
			end)
		end)
	end
end)

-------------------------------------------------------------------
-- Botones de comando (est칠tica mejorada)
-------------------------------------------------------------------
local function createCommandButtons()
	local commands = {"kill", "heal", "Killer", "permGod", "punish", "unpunish", "freeze", "unfreeze", "bring", "to", "b1", "hk", "unlock", "noclans", "Force Lag", "T objetive"}
	for _, cmd in ipairs(commands) do
		local button = Instance.new("TextButton")
		button.Size = UDim2.new(1, 0, 0, 28)
		button.BackgroundColor3 = Color3.fromRGB(235,235,235)
		button.TextColor3 = Color3.fromRGB(20,20,20)
		button.TextScaled = true
		button.Text = string.upper(cmd)
		button.Font = Enum.Font.Gotham
		button.AutoButtonColor = false
		button.Parent = ButtonsFrame

		local corner = Instance.new("UICorner", button); corner.CornerRadius = UDim.new(0,10)
		local stroke = Instance.new("UIStroke", button); stroke.Thickness = 1; stroke.Color = Color3.fromRGB(200,200,200); stroke.Transparency = 0.8

		local original = button.Size
		local hoverSize = UDim2.new(1, 8, 0, 32)
		button.MouseEnter:Connect(function()
			pcall(function()
				TweenService:Create(button, TweenInfo.new(0.12, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {Size = hoverSize}):Play()
				TweenService:Create(button, TweenInfo.new(0.12), {BackgroundColor3 = Color3.fromRGB(200,200,200)}):Play()
			end)
		end)
		button.MouseLeave:Connect(function()
			pcall(function()
				TweenService:Create(button, TweenInfo.new(0.12, Enum.EasingStyle.Quad), {Size = original}):Play()
				TweenService:Create(button, TweenInfo.new(0.12), {BackgroundColor3 = Color3.fromRGB(235,235,235)}):Play()
			end)
		end)

		button.MouseButton1Click:Connect(function()
			spawnParticleEffect(button)
			executeCommand(cmd)
		end)
	end
end
createCommandButtons()

-------------------------------------------------------------------
-- Navegaci칩n teclado para autocompletado: flechas arriba/abajo, Enter/Esc
-------------------------------------------------------------------
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end
	if input.UserInputType ~= Enum.UserInputType.Keyboard then return end
	if SuggestionsFrame.Visible then
		if input.KeyCode == Enum.KeyCode.Down then
			if #suggestionButtons > 0 then
				local nextIdx = selectedIndex + 1
				if nextIdx > #suggestionButtons then nextIdx = 1 end
				setSelectedIndex(nextIdx)
			end
		elseif input.KeyCode == Enum.KeyCode.Up then
			if #suggestionButtons > 0 then
				local prevIdx = selectedIndex - 1
				if prevIdx < 1 then prevIdx = #suggestionButtons end
				setSelectedIndex(prevIdx)
			end
		elseif input.KeyCode == Enum.KeyCode.Return or input.KeyCode == Enum.KeyCode.KeypadEnter then
			if SuggestionsFrame.Visible and selectedIndex >= 1 and suggestionButtons[selectedIndex] then
				local chosen = suggestionButtons[selectedIndex]
				if chosen and chosen.Text then
					InputBox.Text = chosen.Text
					SuggestionsFrame.Visible = false
					clearSuggestions()
				end
			end
		elseif input.KeyCode == Enum.KeyCode.Escape then
			SuggestionsFrame.Visible = false
			clearSuggestions()
		end
	end
end)

-- Enter on InputBox: apply first suggestion or notify
InputBox.FocusLost:Connect(function(enterPressed)
	if enterPressed then
		if SuggestionsFrame.Visible and #suggestionButtons > 0 then
			InputBox.Text = suggestionButtons[1].Text
			SuggestionsFrame.Visible = false
			clearSuggestions()
			return
		end
		StarterGui:SetCore("SendNotification", { Title = "游낼Dragon Core", Text = "Pulsa un bot칩n de comando para ejecutar.", Duration = 1 })
	end
end)

-- FIN
