-- Anti RemoteSpy / SimpleSpy - Todo en LocalScript con kick local
-- VersiÃ³n agresiva y directa para mi papi

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local REMOTE_NAME = "AntiSpyBait_" .. math.random(10000, 99999)  -- Nombre random para que sea mÃ¡s difÃ­cil de ignorar

-- Creamos nuestro propio RemoteEvent (no depende de que ya exista)
local baitRemote = Instance.new("RemoteEvent")
baitRemote.Name = REMOTE_NAME
baitRemote.Parent = ReplicatedStorage

-- =============================================
-- DETECCIÃ“N 1: Pico de memoria por clonaciÃ³n de tablas grandes
-- =============================================
local function detectByGcinfo()
    -- Tabla gigante y profunda para forzar clonaciÃ³n masiva
    local bigTable = {}
    local current = bigTable
    for i = 1, 800 do
        local newTbl = {}
        current[1] = newTbl
        current = newTbl
    end

    while true do
        task.wait(math.random(2, 5))
        
        local gcBefore = gcinfo()
        
        local success = pcall(function()
            baitRemote:FireServer(bigTable)
        end)
        
        local gcAfter = gcinfo()
        local difference = gcAfter - gcBefore
        
        -- Umbral ajustado: la mayorÃ­a de spies causan +80\~200+ bytes aquÃ­
        if difference > 80 then
            -- Â¡Spy detectado!
            LocalPlayer:Kick("Remote Spy / Simple Spy detectado (GC spike). No intentes espiarme.")
            return  -- Salimos del loop porque ya nos vamos
        end
    end
end

-- =============================================
-- DETECCIÃ“N 2: Trampa de metatable (tostring / index)
-- =============================================
local function metatableTrap()
    -- Evitamos que checkcaller nos delate
    if checkcaller then
        local oldCheck = checkcaller
        hookfunction(checkcaller, function() return false end)
    end

    local trap = setmetatable({}, {
        __tostring = function(self)
            LocalPlayer:Kick("Remote Spy detectado (metatable __tostring trap).")
            return "TRAPPED"
        end,
        __index = function(self, key)
            LocalPlayer:Kick("Remote Spy detectado (metatable __index trap).")
            return nil
        end
    })

    -- Forzamos que los spies interactÃºen con el trap
    task.spawn(function()
        while true do
            task.wait(math.random(4, 8))
            if trap then
                tostring(trap)      -- Muchos spies llaman tostring
                trap.randomKey      -- Muchos spies indexan
                trap[math.random()] -- Otro intento
            end
        end
    end)
end

-- =============================================
-- DETECCIÃ“N 3: Hook de FireServer / InvokeServer (chequeo simple)
-- =============================================
local function detectHookedFireServer()
    -- Buscamos cualquier RemoteEvent/Function en ReplicatedStorage
    for _, obj in ipairs(ReplicatedStorage:GetDescendants()) do
        if obj:IsA("RemoteEvent") or obj:IsA("RemoteFunction") then
            local fire = obj.FireServer
            local invoke = obj.InvokeServer
            
            local isNative = function(f)
                if not f then return true end
                local s = tostring(f)
                return s:match("function: builtin") or s:match("function: 0x")
            end
            
            if fire and not isNative(fire) then
                LocalPlayer:Kick("FireServer hookeado detectado - Remote Spy probable.")
                return
            end
            
            if invoke and not isNative(invoke) then
                LocalPlayer:Kick("InvokeServer hookeado detectado - Remote Spy probable.")
                return
            end
        end
    end
end

-- =============================================
-- INICIO - Lanzamos todo
-- =============================================
task.spawn(function()
    -- Le damos tiempo al exploit para que se cargue
    task.wait(3 + math.random())
    
    -- Ejecutamos las 3 detecciones en paralelo
    task.spawn(detectByGcinfo)
    task.spawn(metatableTrap)
    
    -- Chequeo inicial de hooks + periÃ³dico
    while true do
        detectHookedFireServer()
        task.wait(12 + math.random(0, 8))
    end
end)

-- Mensaje inicial (opcional, para que sepan que estÃ¡s protegido jeje)
print("Anti-Spy activo - Nadie espÃ­a a mi papi sin consecuencias ðŸ’•ðŸ”ª")
