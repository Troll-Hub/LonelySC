-- Script LocalScript para ejecutores de Roblox (Synapse, Krnl, Fluxus, Solara, etc.)
-- üíã AHORA CON DRAG + TOUCH (m√≥vil perfecto, papi! üòà Mueve la GUI arrastrando el t√≠tulo)
-- Permite chat P2P entre dos clientes v√≠a rentry.co (HTTP polling + update)
-- + Ejecuci√≥n remota de c√≥digo (prefijo "//EXEC <c√≥digo>")
-- Uso: Ambos jugadores usan el MISMO "channel" (secreto compartido, ej: "miroom123")
-- Activa "AutoExec" para ejecutar c√≥digos recibidos autom√°ticamente (¬°cuidado, conf√≠a en el otro!)

local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")

local http_request = request or http_request or (syn and syn.request) or (http and http.request) or error("Executor no soporta HTTP")

local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "ExecutorChatP2P"
ScreenGui.Parent = CoreGui
ScreenGui.ResetOnSpawn = false

local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 450, 0, 550)
MainFrame.Position = UDim2.new(0, 20, 0, 20)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
MainFrame.BorderSizePixel = 0
MainFrame.Parent = ScreenGui
MainFrame.Active = true  -- Para drag

local UICorner = Instance.new("UICorner")
UICorner.CornerRadius = UDim.new(0, 12)
UICorner.Parent = MainFrame

local Title = Instance.new("TextLabel")
Title.Size = UDim2.new(1, 0, 0, 40)
Title.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
Title.BorderSizePixel = 0
Title.Text = "üí¨ Chat P2P + RCE para Ejecutores"
Title.TextColor3 = Color3.new(1,1,1)
Title.TextScaled = true
Title.Font = Enum.Font.GothamBold
Title.Parent = MainFrame

local UICornerTitle = Instance.new("UICorner")
UICornerTitle.CornerRadius = UDim.new(0, 12)
UICornerTitle.Parent = Title

-- ü•µ DRAG + TOUCH MAGIC (arrastrar t√≠tulo con mouse o dedo)
local dragging = false
local dragStart = nil
local startPos = nil

Title.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = true
        dragStart = input.Position
        startPos = MainFrame.Position
    end
end)

Title.InputChanged:Connect(function(input)
    if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
        local delta = input.Position - dragStart
        MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
end)

UserInputService.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
        dragging = false
    end
end)

-- Variables
local channel = ""
local myName = ""
local connected = false
local autoExec = false
local lastContent = ""
local ChatScroll = nil
local ListLayout = nil
local InputBox = nil
local CodeBox = nil

-- Funci√≥n para crear labels en scroll
local function createLabel(text)
    local lbl = Instance.new("TextLabel")
    lbl.BackgroundTransparency = 1
    lbl.Size = UDim2.new(1, -15, 0, 0)
    lbl.Text = text
    lbl.TextColor3 = Color3.new(1, 1, 1)
    lbl.TextSize = 14
    lbl.Font = Enum.Font.SourceSans
    lbl.TextXAlignment = Enum.TextXAlignment.Left
    lbl.TextWrapped = true
    lbl.LayoutOrder = 999 -- Se ordena por layout
    lbl.Parent = ChatScroll
    return lbl
end

-- Actualizar chat
local function updateChat(content)
    lastContent = content
    -- Limpiar
    for _, child in pairs(ChatScroll:GetChildren()) do
        if child:IsA("TextLabel") then
            child:Destroy()
        end
    end
    -- L√≠neas
    local lines = {}
    for line in content:gmatch("[^\n\r]+") do
        if line ~= "" then
            table.insert(lines, line)
        end
    end
    -- Crear labels
    for i, line in ipairs(lines) do
        createLabel(line)
        -- AutoExec?
        if autoExec and line:find("^//EXEC ") then
            local code = line:match("^//EXEC (.*)")
            local success, func = pcall(loadstring, code)
            if success and func then
                pcall(func)
                createLabel("[RCE] Ejecutado: " .. code:sub(1, 50) .. (code:len() > 50 and "..." or ""))
            end
        end
    end
end

-- Polling loop
local pollConnection
local function startPolling()
    if pollConnection then pollConnection:Disconnect() end
    spawn(function()
        while connected do
            local ok, res = pcall(http_request, {
                Url = "https://rentry.co/" .. channel .. "/raw",
                Method = "GET"
            })
            if ok and res.StatusCode == 200 then
                local body = res.Body or ""
                if body ~= lastContent then
                    updateChat(body)
                end
            end
            wait(0.4) -- Bajo lag
        end
    end)
end

-- Enviar mensaje
local function sendMessage(msg, isCode)
    if not connected then return end
    local prefix = isCode and "//EXEC " or ""
    msg = prefix .. msg
    local ok, res = pcall(http_request, {
        Url = "https://rentry.co/" .. channel .. "/raw",
        Method = "GET"
    })
    local curr = ok and res.StatusCode == 200 and (res.Body or "") or ""
    local newBody = curr .. "\n" .. myName .. ": " .. msg
    pcall(http_request, {
        Url = "https://rentry.co/" .. channel .. "/raw",
        Method = "PUT",
        Headers = {
            ["Content-Type"] = "text/plain; charset=utf-8"
        },
        Body = newBody
    })
end

-- Inputs
local InputFrame = Instance.new("Frame")
InputFrame.Size = UDim2.new(1, -20, 0, 35)
InputFrame.Position = UDim2.new(0, 10, 1, -45)
InputFrame.BackgroundTransparency = 1
InputFrame.Parent = MainFrame

InputBox = Instance.new("TextBox")
InputBox.Size = UDim2.new(1, -80, 1, 0)
InputBox.Position = UDim2.new(0, 0, 0, 0)
InputBox.PlaceholderText = "Escribe mensaje..."
InputBox.Text = ""
InputBox.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
InputBox.TextColor3 = Color3.new(1,1,1)
InputBox.Font = Enum.Font.SourceSans
InputBox.TextSize = 14
InputBox.Parent = InputFrame

local SendBtn = Instance.new("TextButton")
SendBtn.Size = UDim2.new(0, 70, 1, 0)
SendBtn.Position = UDim2.new(1, -70, 0, 0)
SendBtn.Text = "Enviar"
SendBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
SendBtn.TextColor3 = Color3.new(1,1,1)
SendBtn.Font = Enum.Font.GothamBold
SendBtn.Parent = InputFrame

-- Code input
local CodeFrame = Instance.new("Frame")
CodeFrame.Size = UDim2.new(1, -20, 0, 35)
CodeFrame.Position = UDim2.new(0, 10, 1, -85)
CodeFrame.BackgroundTransparency = 1
CodeFrame.Parent = MainFrame

CodeBox = Instance.new("TextBox")
CodeBox.Size = UDim2.new(1, -80, 1, 0)
CodeBox.PlaceholderText = "C√≥digo Lua para enviar (ej: print('hi'))"
CodeBox.Text = ""
CodeBox.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
CodeBox.TextColor3 = Color3.new(1,1,1)
CodeBox.Font = Enum.Font.SourceSans
CodeBox.TextSize = 14
CodeBox.Parent = CodeFrame

local ExecBtn = Instance.new("TextButton")
ExecBtn.Size = UDim2.new(0, 70, 1, 0)
ExecBtn.Position = UDim2.new(1, -70, 0, 0)
ExecBtn.Text = "RCE ‚û§"
ExecBtn.BackgroundColor3 = Color3.fromRGB(170, 0, 0)
ExecBtn.TextColor3 = Color3.new(1,1,1)
ExecBtn.Font = Enum.Font.GothamBold
ExecBtn.Parent = CodeFrame

-- Config top
local ConfigFrame = Instance.new("Frame")
ConfigFrame.Size = UDim2.new(1, -20, 0, 80)
ConfigFrame.Position = UDim2.new(0, 10, 0, 45)
ConfigFrame.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
ConfigFrame.Parent = MainFrame

local NameLabel = Instance.new("TextLabel")
NameLabel.Size = UDim2.new(0.3, 0, 0.5, 0)
NameLabel.Position = UDim2.new(0, 10, 0, 5)
NameLabel.Text = "Tu Nombre:"
NameLabel.BackgroundTransparency = 1
NameLabel.TextColor3 = Color3.new(0.8,0.8,0.8)
NameLabel.Font = Enum.Font.SourceSansBold
NameLabel.TextSize = 13
NameLabel.Parent = ConfigFrame

local NameInput = Instance.new("TextBox")
NameInput.Size = UDim2.new(0.65, -10, 0.5, 0)
NameInput.Position = UDim2.new(0.3, 0, 0, 5)
NameInput.PlaceholderText = "PapiDavid"
NameInput.Text = Players.LocalPlayer.Name
NameInput.BackgroundColor3 = Color3.fromRGB(60,60,65)
NameInput.TextColor3 = Color3.new(1,1,1)
NameInput.Font = Enum.Font.SourceSans
NameInput.TextSize = 14
NameInput.Parent = ConfigFrame

local ChannelLabel = Instance.new("TextLabel")
ChannelLabel.Size = UDim2.new(0.3, 0, 0.5, 0)
ChannelLabel.Position = UDim2.new(0, 10, 0.5, 5)
ChannelLabel.Text = "Channel:"
ChannelLabel.BackgroundTransparency = 1
ChannelLabel.TextColor3 = Color3.new(0.8,0.8,0.8)
ChannelLabel.Font = Enum.Font.SourceSansBold
ChannelLabel.TextSize = 13
ChannelLabel.Parent = ConfigFrame

local ChannelInput = Instance.new("TextBox")
ChannelInput.Size = UDim2.new(0.65, -10, 0.5, 0)
ChannelInput.Position = UDim2.new(0.3, 0, 0.5, 5)
ChannelInput.PlaceholderText = "miroom123 (secreto compartido)"
ChannelInput.Text = ""
ChannelInput.BackgroundColor3 = Color3.fromRGB(60,60,65)
ChannelInput.TextColor3 = Color3.new(1,1,1)
ChannelInput.Font = Enum.Font.SourceSans
ChannelInput.TextSize = 14
ChannelInput.Parent = ConfigFrame

local ConnectBtn = Instance.new("TextButton")
ConnectBtn.Size = UDim2.new(0, 100, 0, 30)
ConnectBtn.Position = UDim2.new(1, -110, 0.5, -15)
ConnectBtn.Text = "üîå Conectar"
ConnectBtn.BackgroundColor3 = Color3.fromRGB(0, 120, 255)
ConnectBtn.TextColor3 = Color3.new(1,1,1)
ConnectBtn.Font = Enum.Font.GothamBold
ConnectBtn.TextSize = 14
ConnectBtn.Parent = ConfigFrame

local AutoExecBtn = Instance.new("TextButton")
AutoExecBtn.Size = UDim2.new(0, 120, 0, 25)
AutoExecBtn.Position = UDim2.new(0, 10, 1, -30)
AutoExecBtn.Text = "AutoExec: OFF ‚ö†Ô∏è"
AutoExecBtn.BackgroundColor3 = Color3.fromRGB(200, 50, 50)
AutoExecBtn.TextColor3 = Color3.new(1,1,1)
AutoExecBtn.Font = Enum.Font.Gotham
AutoExecBtn.TextSize = 12
AutoExecBtn.Parent = MainFrame

-- Status
local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(1, 0, 0, 25)
StatusLabel.Position = UDim2.new(0, 0, 0, 130)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Estado: Desconectado"
StatusLabel.TextColor3 = Color3.new(1, 0.5, 0.5)
StatusLabel.Font = Enum.Font.SourceSansBold
StatusLabel.TextSize = 14
StatusLabel.Parent = MainFrame

-- Chat Scroll
ChatScroll = Instance.new("ScrollingFrame")
ChatScroll.Size = UDim2.new(1, -20, 1, -170)
ChatScroll.Position = UDim2.new(0, 10, 0, 160)
ChatScroll.BackgroundColor3 = Color3.fromRGB(25, 25, 30)
ChatScroll.BorderSizePixel = 0
ChatScroll.ScrollBarThickness = 8
ChatScroll.ScrollBarImageColor3 = Color3.fromRGB(100,100,100)
ChatScroll.CanvasSize = UDim2.new(0,0,0,0)
ChatScroll.Parent = MainFrame

ListLayout = Instance.new("UIListLayout")
ListLayout.SortOrder = Enum.SortOrder.LayoutOrder
ListLayout.Padding = UDim.new(0, 3)
ListLayout.Parent = ChatScroll

ListLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    ChatScroll.CanvasSize = UDim2.new(0, 0, 0, ListLayout.AbsoluteContentSize.Y + 10)
end)

-- Eventos
ConnectBtn.MouseButton1Click:Connect(function()
    channel = ChannelInput.Text:gsub("%s+", "") -- No espacios
    myName = NameInput.Text
    if channel == "" then
        StatusLabel.Text = "‚ùå Channel vac√≠o!"
        return
    end
    -- Crear si no existe
    local res = http_request({Url = "https://rentry.co/" .. channel .. "/raw", Method = "GET"})
    if res.StatusCode == 404 then
        local postBody = string.format("rentry_name=%s&rentry_title=%s Chat&rentry=¬°Bienvenido %s! Esperando al otro jugador...\n", channel, channel, myName)
        local createRes = http_request({
            Url = "https://rentry.co/api/pastes/new",
            Method = "POST",
            Headers = {["Content-Type"] = "application/x-www-form-urlencoded"},
            Body = postBody
        })
        if createRes.StatusCode ~= 200 then
            StatusLabel.Text = "‚ùå Error creando room: " .. tostring(createRes.StatusCode)
            return
        end
    end
    connected = true
    StatusLabel.Text = "‚úÖ Conectado a '" .. channel .. "'"
    StatusLabel.TextColor3 = Color3.new(0,1,0)
    startPolling()
    updateChat("¬°Conectado!")
end)

SendBtn.MouseButton1Click:Connect(function()
    local msg = InputBox.Text
    if msg ~= "" then
        sendMessage(msg, false)
        InputBox.Text = ""
    end
end)

InputBox.FocusLost:Connect(function(enterPressed)
    if enterPressed then SendBtn.MouseButton1Click:Fire() end
end)

ExecBtn.MouseButton1Click:Connect(function()
    local code = CodeBox.Text
    if code ~= "" then
        sendMessage(code, true)
        CodeBox.Text = ""
    end
end)

AutoExecBtn.MouseButton1Click:Connect(function()
    autoExec = not autoExec
    AutoExecBtn.Text = autoExec and "AutoExec: ON üî•" or "AutoExec: OFF ‚ö†Ô∏è"
    AutoExecBtn.BackgroundColor3 = autoExec and Color3.fromRGB(0,170,0) or Color3.fromRGB(200,50,50)
end)

-- Corners menores
for _, obj in pairs({InputBox, CodeBox, NameInput, ChannelInput, SendBtn, ExecBtn, ConnectBtn, AutoExecBtn}) do
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = obj
end

local gradient = Instance.new("UIGradient")
gradient.Color = ColorSequence.new{
    ColorSequenceKeypoint.new(0, Color3.fromRGB(0,170,255)),
    ColorSequenceKeypoint.new(1, Color3.fromRGB(100,0,255))
}
gradient.Rotation = 45
gradient.Parent = ConnectBtn

print("üü¢ Script cargado CON DRAG + TOUCH! üòà Arrastra el t√≠tulo con mouse/dedo.")
print("Ej: Env√≠a '//EXEC game.Players.LocalPlayer.Character.HumanoidRootPart.CFrame = CFrame.new(0,100,0)' para teletransportar al otro.")
